{% extends 'base.html' %}

{% block title %}Book Property - RentalSystem{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-calendar-check"></i> Book Property</h4>
                </div>
                <div class="card-body">
                    <!-- Property Summary -->
                    <div class="property-summary mb-4 p-3 bg-light rounded">
                        <h5>{{ property.title }}</h5>
                        <p class="mb-1"><i class="fas fa-map-marker-alt"></i> {{ property.city }}, {{ property.state }}</p>
                        <p class="mb-1"><strong>Rent: ${{ property.rent_amount }}/month</strong></p>
                        <p class="mb-0">Security Deposit: ${{ property.security_deposit|default:property.rent_amount }}</p>
                    </div>

                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Start Date *</label>
                                {{ form.start_date }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">End Date *</label>
                                {{ form.end_date }}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Total Amount</label>
                                <input type="text" id="calculated-amount" class="form-control" value="${{ property.rent_amount }}" disabled>
                                <input type="hidden" id="calculated-months" name="calculated_months" value="1">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Special Requests</label>
                            {{ form.special_requests }}
                        </div>

                        <!-- Booking Summary -->
                        <div class="booking-summary p-3 bg-light rounded mb-4">
                            <h6>Booking Summary</h6>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Monthly Rent:</span>
                                <span>${{ property.rent_amount }}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Rental Duration (months):</span>
                                <span id="summary-months">1</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Security Deposit:</span>
                                <span>${{ property.security_deposit|default:property.rent_amount }}</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between">
                                <strong>Total Rent (all months):</strong>
                                <strong id="summary-total">${{ property.rent_amount }}</strong>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-calendar-check"></i> Confirm Booking
                            </button>
                            <a href="{% url 'property_detail' property.property_id %}" class="btn btn-secondary btn-lg">
                                <i class="fas fa-arrow-left"></i> Back to Property
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
                <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const startInput = document.querySelector('input[name="start_date"]');
                    const endInput = document.querySelector('input[name="end_date"]');
                    const calcAmount = document.getElementById('calculated-amount');
                    const calcMonths = document.getElementById('calculated-months');
                    const summaryMonths = document.getElementById('summary-months');
                    const summaryTotal = document.getElementById('summary-total');
                    const rent = parseFloat('{{ property.rent_amount }}');
                    const secDeposit = parseFloat('{{ property.security_deposit|default:property.rent_amount }}');

                    function updateCalculation() {
                        const start = startInput.value ? new Date(startInput.value) : null;
                        const end = endInput.value ? new Date(endInput.value) : null;
                        let months = 1;
                        if (start && end && end > start) {
                            const diffDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                            months = Math.max(1, Math.ceil(diffDays / 30));
                        }
                        const total = (rent * months).toFixed(2);
                        calcAmount.value = '$' + total;
                        calcMonths.value = months;
                        summaryMonths.textContent = months;
                        summaryTotal.textContent = '$' + total;
                    }

                    if (startInput) startInput.addEventListener('change', updateCalculation);
                    if (endInput) endInput.addEventListener('change', updateCalculation);

                    updateCalculation();
                });
                </script>
{% endblock %}